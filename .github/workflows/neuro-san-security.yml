name: Cognizant Neuro-SAN Security Orchestration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allows Neuro-SAN to trigger the pipeline via HTTP POST if needed
  repository_dispatch:
    types: [neuro_san_scan]

jobs:
  security-management:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Trigger Neuro-SAN Streaming Chat API
        run: |
          # Test connection first
          echo "üîç Testing connection to Neuro SAN server..."
          if ! curl -s --max-time 10 "http://127.0.0.1:8080" > /dev/null; then
            echo "‚ùå Error: Cannot connect to Neuro SAN server"
            echo "Server URL: http://127.0.0.1:8080"
            echo ""
            echo "Possible issues:"
            echo "1. Server is not running or not accessible from GitHub Actions"
            echo "2. URL is incorrect (should include http:// or https://)"
            echo "3. Server is behind firewall/VPN"
            echo "4. Server is running on localhost (not accessible from CI/CD)"
            echo ""
            echo "Solutions:"
            echo "‚Ä¢ Make sure your Neuro SAN server is publicly accessible"
            echo "‚Ä¢ Use ngrok or similar for localhost: ngrok http 8080"
            echo "‚Ä¢ Deploy server to cloud (Azure, AWS, etc.)"
            echo "‚Ä¢ Use GitHub self-hosted runner in your network"
            exit 1
          fi
          
          echo "‚úÖ Connection successful"
          
          # The NEURO_API_KEY is pulled securely from your GitHub Secrets
          echo "üì° Calling security vulnerability management agent..."
          curl -X POST "http://127.0.0.1:8080/api/v1/security_vulnerability_management/streaming_chat" \
          -H "Content-Type: application/json" \
          -d '{
            "user_message": {
              "type": 2,
              "text": "Initiate vulnerability management orchestration for repo ${{ github.repository }}."
            },
            "sly_data": {
              "repository_url": "${{ github.server_url }}/${{ github.repository }}",
              "commit_id": "${{ github.sha }}",
              "config_file": "security_vulnerability_management.hocon"
            },
            "chat_context": {},
            "chat_filter": {}
          }'
