name: Cognizant Neuro-SAN Security Orchestration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allows Neuro-SAN to trigger the pipeline via HTTP POST if needed
  repository_dispatch:
    types: [neuro_san_scan]

jobs:
  security-management:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Trigger Neuro-SAN Streaming Chat API
        run: |
          # Test connection first
          echo "üîç Testing connection to Neuro SAN server..."
          if ! curl -s --max-time 10 "http://192.168.1.7:8001/trigger-security-scan" > /dev/null; then
            echo "‚ùå Error: Cannot connect to Neuro SAN server"
            echo "Server URL: http://192.168.1.7:8001"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ Connection successful"
          
          # The NEURO_API_KEY is pulled securely from your GitHub Secrets
          echo "üì° Calling security vulnerability management agent..."
          curl -X POST "http://192.168.1.7:8001/trigger-security-scan" \
          -H "Content-Type: application/json" \
          -d '{
              "repository_url": "${{ github.server_url }}/${{ github.repository }}",
              "commit_id": "${{ github.sha }}"
          }'
