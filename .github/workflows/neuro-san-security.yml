name: Cognizant Neuro-SAN Security Orchestration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allows Neuro-SAN to trigger the pipeline via HTTP POST if needed
  repository_dispatch:
    types: [neuro_san_scan]

jobs:
  security-management:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Trigger Neuro-SAN Streaming Chat API
        run: |
          # The NEURO_API_KEY is pulled securely from your GitHub Secrets
          echo "ðŸ“¡ Calling security vulnerability management agent..."
          curl -s -w "%{http_code}" -o response.json \
            -X POST "http://localhost:8080/api/execute" \
            -H "Content-Type: application/json" \
            -d '{
              "registry": "registries/security_vulnerability_management.hocon",
              "config": {
                "repository": "${{ github.repository }}",
                "branch": "${{ github.ref_name }}",
                "commit": "${{ github.sha }}",
                "triggered_by": "github_actions",
                "event_type": "${{ github.event_name }}"
              }
            }' > http_status.txt
          HTTP_STATUS=$(cat http_status.txt)

          # Defensive: If curl fails, HTTP_STATUS may be empty
          if [ -z "$HTTP_STATUS" ]; then
            echo "âŒ Failed to contact Neuro SAN agent (no HTTP status returned)"
            cat response.json 2>/dev/null || echo "No response body"
            exit 1
          fi
          
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Security scan request sent successfully"
            echo ""
            echo "Your Neuro SAN agent is now processing:"
            echo "  â€¢ Vulnerability Scout - Scanning for vulnerabilities"
            echo "  â€¢ Risk Analyst - Assessing business impact" 
            echo "  â€¢ Remediation Architect - Planning fixes"
            echo "  â€¢ Compliance Auditor - Validating compliance"
            echo ""
            echo "Check your Neuro SAN server logs for detailed results."
            
            # Show response if available
            if [ -f response.json ]; then
              echo "Response:"
              cat response.json
            fi
          else
            echo "âŒ Security scan request failed (HTTP $HTTP_STATUS)"
            echo "Response:"
            cat response.json 2>/dev/null || echo "No response body"
            exit 1
          fi

         
