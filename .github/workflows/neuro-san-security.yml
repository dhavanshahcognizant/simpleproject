name: Cognizant Neuro-SAN Security Orchestration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allows Neuro-SAN to trigger the pipeline via HTTP POST if needed
  repository_dispatch:
    types: [neuro_san_scan]

jobs:
  security-management:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Neuro-SAN and Trigger Orchestration
        run: |
          # 1. Start the server in the background
          python run.py --neuro-san-server --port 8080 --registry registries/security_vulnerability_management.hocon &
          
          # 2. Wait a few seconds for the server to initialize
          sleep 1000
          
          # 3. Now run the curl command (connecting to the background process)
          curl -X POST "http://localhost:8080/api/v1/security_vulnerability_management/streaming_chat" \
          -H "Authorization: Bearer ${{ secrets.NEURO_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "user_message": {
              "type": 2,
              "text": "Initiate vulnerability management orchestration."
            },
            "sly_data": {
              "repository_url": "${{ github.server_url }}/${{ github.repository }}",
              "commit_id": "${{ github.sha }}",
              "config_file": "security_vulnerability_management.hocon"
            },
            "chat_context": {},
            "chat_filter": {}
          }'
         
